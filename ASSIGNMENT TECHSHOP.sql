-----1.Database
CREATE DATABASE TECHSHOP;
-----2.DDL
CREATE TABLE CUSTOMERS
(
CID INT PRIMARY KEY,
FNAME VARCHAR(50),
LNAME VARCHAR(50),
EMAIL VARCHAR (50),
PHONE CHAR(10),
ADDRS VARCHAR(50)
);
CREATE TABLE PRODUCTS
(
PID INT PRIMARY KEY,
PNAME VARCHAR(50),
DESCRIP VARCHAR(100),
PRICE INT
);
CREATE TABLE ORDERS
(
ORID INT PRIMARY KEY,
CID INT FOREIGN KEY (CID) REFERENCES [dbo].[CUSTOMERS]([CID]),
ORDATE DATE,
TOTAMT INT
);
CREATE TABLE ORDERDETAILS
(
ORDETAID INT PRIMARY KEY,
ORID INT FOREIGN KEY (ORID) REFERENCES [dbo].[ORDERS]([ORID]),
PID INT FOREIGN KEY (PID) REFERENCES [dbo].[PRODUCTS]([PID]),
QUANT INT
);
CREATE TABLE INVENTORY
(
INVENID INT PRIMARY KEY,
PID INT FOREIGN KEY (PID) REFERENCES [dbo].[PRODUCTS]([PID]),
QINSTOCK INT,
LASTUPDATE INT
);
-----3.DML
--(3a)
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (1,'John', 'Doe', 'john.doe@email.com',9876567890, '123 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (2,'Jane', 'Smith', 'jane.smith@email.com',9872236789, '124 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (3,'Bob', 'Johnson', 'bob.johnson@email.com',6353567891, '153 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (4,'Alice', 'Williams', 'alice.williams@email.com',7276560897, '193 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (5,'Charlie', 'Brown', 'charlie.brown@email.com',6376567893, '132 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (6,'Eva', 'Miller', 'eva.miller@email.com',9879997896, '223 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (7,'David', 'Smithson', 'david.smithson@email.com',1234656789, '343 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (8,'Grace', 'Taylor', 'grace.taylor@email.com',9876117894, '73 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (9,'Frank', 'Anderson', 'frank.anderson@email.com',9873467898, '93 street');
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[PHONE],[ADDRS])
VALUES (10,'Sophia', 'Baker', 'sophia.baker@email.com',9876561292, '271 street');

INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(11,'Laptop','High-performance laptop with SSD',60000);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(22,'Smartphone','6.5-inch display, 128GB storage',20000);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(33,'Headphones','Noise-canceling over-ear headphones',30000);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(44,'Wireless Mouse','Ergonomic wireless mouse',500);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(55,'Bluetooth Speaker','Portable speaker with long battery life',5000);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(66,'Digital Camera ','20MP DSLR camera with zoom lens',25000);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(77,'Smartwatch','Fitness tracker with heart rate monitor',6000);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(88,'Desktop Computer','Powerful desktop with high-end specs',15000);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(99,'Tablet ','10-inch tablet with HD display',30000);
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(15,'Fitness Tracker','Track your steps and monitor health',8000);

INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(100,1,'2023-01-12',50000);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(101,2,'2023-11-22',55600);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(102,3,'2023-04-05',90000);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(103,4,'2023-07-12',70000);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(104,5,'2023-06-10',40000);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(105,6,'2023-01-06',58000);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(106,7,'2023-08-05',30000);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(107,8,'2023-09-02',65000);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(108,9,'2023-03-21',34000);
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(109,10,'2023-02-25',80000);

INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(239,100,11,65);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(331,101,22,85);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(534,102,33,67);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(634,103,44,63);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(554,104,55,12);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(224,105,66,15);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(285,106,77,64);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(612,107,88,22);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(271,108,99,34);
INSERT INTO [dbo].[ORDERDETAILS]([ORDETAID],[ORID],[PID],[QUANT])VALUES(236,109,15,76);

INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1223,11,12,45);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1523,22,16,32);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1343,33,11,43);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1123,44,12,75);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1283,55,19,95);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1113,66,62,85);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1543,77,52,88);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1233,88,17,25);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1173,99,32,71);
INSERT INTO[dbo].[INVENTORY]([INVENID],[PID],[QINSTOCK],[LASTUPDATE])VALUES(1239,15,28,56);

-----(3b)
--Q1
SELECT [FNAME],[LNAME],[EMAIL] FROM [dbo].[CUSTOMERS];
--Q2
SELECT [ORID],[ORDATE], C.[FNAME]FROM [dbo].[ORDERS] AS O
INNER JOIN [dbo].[CUSTOMERS] AS C ON O.[CID]=C.[CID];
--Q3
INSERT INTO [dbo].[CUSTOMERS]([CID],[FNAME],[LNAME],[EMAIL],[ADDRS])
VALUES (11,'Div', 'Das', 'div.dos@email.com', '23 street');
--Q4
SELECT [PRICE] FROM [dbo].[PRODUCTS];
UPDATE [dbo].[PRODUCTS] SET [PRICE]=[PRICE]*1.10;
--Q5
DECLARE @INP INT;
SET @INT=1;
SELECT * FROM [dbo].[ORDERS] WHERE [ORID]=@INP;
DELETE FROM [dbo].[ORDERS] WHERE [ORID]=@INP;
DELETE FROM [dbo].[ORDERDETAILS] WHERE [ORID]=@INP;
--Q6
INSERT INTO [dbo].[ORDERS]([ORID],[CID],[ORDATE],[TOTAMT])
VALUES(200,1,'2023-05-02',52000);
--Q7
DECLARE @INP INT;
SET @INT=1;
SELECT * FROM [dbo].[CUSTOMERS] WHERE [CID]=@INP;
UPDATE [dbo].[CUSTOMERS] SET [EMAIL]='erer@email.com'WHERE [CID]=@INP;
UPDATE [dbo].[CUSTOMERS] SET [ADDRS]='345 st'WHERE [CID]=@INP;
--Q9
DECLARE @INP INT;
SET @INT=1;
SELECT * FROM [dbo].[CUSTOMERS] WHERE [CID]=@INP;
DELETE FROM [dbo].[ORDERS] WHERE [CID]=@INP;
DELETE FROM [dbo].[ORDERDETAILS] WHERE [CID]=@INP;
--Q10
INSERT INTO [dbo].[PRODUCTS]([PID],[PNAME],[DESCRIP],[PRICE])
VALUES(25,'Coffe Maker','programmable coffe maker with timer',10000);

----4.JOINS
--Q1
SELECT [FNAME],[LNAME] FROM [dbo].[CUSTOMERS] AS N
INNER JOIN [dbo].[ORDERS] AS CID ON N.[CID]=CID.[CID];
--Q2
SELECT [PNAME],[PRICE] FROM [dbo].[PRODUCTS] AS P
INNER JOIN [dbo].[ORDERDETAILS] AS OD ON P.[PID]=OD.[PID]
INNER JOIN [dbo].[ORDERS] AS O ON OD.ORID=O.ORID;
--Q4
SELECT [QUANT] FROM [dbo].[ORDERDETAILS] AS OD
INNER JOIN [dbo].[PRODUCTS] AS P ON OD.[PID]=P.[PID]
ORDER BY [QUANT] DESC; 
--Q5
SELECT [PNAME] FROM [dbo].[PRODUCTS] AS P
INNER JOIN [dbo].[INVENTORY] AS I ON P.[PID]=I.[PID];
--Q6
SELECT C.FNAME ,C.CID,AVG(O.TOTAMT) FROM[dbo].[CUSTOMERS] AS C
JOIN [dbo].[ORDERS] AS O ON C.[CID]=O.[CID];
--Q7
SELECT O.ORID,C.FNAME,SUM(OD.QUANT) FROM [dbo].[CUSTOMERS] AS C
JOIN [dbo].[ORDERS] AS O ON C.[CID]=O.[CID]
JOIN [dbo].[ORDERDETAILS] AS OD ON O.ORID=OD.ORID
GROUP BY C.CID,O.ORID,C.FNAME
ORDER BY OD.QUANT DESC;
--Q8
SELECT P.PID,P.PNAME,COUNT(OD.ORDETAID) FROM [dbo].[PRODUCTS] AS P
JOIN [dbo].[ORDERDETAILS] AS OD ON P.[PID]=OD.PID
GROUP BY P.PID
ORDER BY COUNT(OD.ORDETAID) DESC;
--Q9
DECLARE @INP INT;
SET @INT=1;
SELECT * FROM [dbo].[PRODUCTS] WHERE [PNAME]=@INP
SELECT C.CID,C.FNAME,P.PNAME FROM [dbo].[CUSTOMERS] AS C 
JOIN [dbo].[ORDERS] AS O ON C.[CID]=O.[CID]
JOIN [dbo].[ORDERDETAILS] AS OD ON O.ORID=OD.ORID
JOIN [dbo].[PRODUCTS] AS P ON OD.PID=P.PID
GROUP BY C.CID,O.ORID,P.PNAME


----5.AGG FUNCT
--Q1
SELECT CID,FNAME FROM [dbo].[CUSTOMERS]
WHERE CID NOT IN( SELECT DISTINCT CID FROM [dbo].[ORDERS]);
--Q2
SELECT [PID],count(*) from [dbo].[PRODUCTS]
GROUP BY [PID];
--Q3
select sum([TOTAMT]) as Rev_gen from [dbo].[ORDERS];
--Q5
DECLARE @CUSID INT; 
SET @CUSID = 1;
SELECT CID,FNAME (SELECT QUANT FROM [dbo].[ORDERDETAILS] AS OD WHERE OD.ORID IN (SELECT ORID FROM [dbo].[ORDERS] WHERE CID=@CUSID ))
FROM [dbo].[CUSTOMERS] WHERE CID=@CUSID;
--Q6
SELECT C.FNAME,C.Lname,O.ORID AS order_count FROM [dbo].[CUSTOMERS] AS C
join [dbo].[ORDERS] AS O ON C.CID=O.CID
WHERE O.ORID =(SELECT MAX(ORID) FROM [dbo].[ORDERS]);
--Q8
SELECT A.FNAME,A.LNAME,A.Totalspending FROM(
SELECT TOP 1 C.FNAME, C.LNAME, SUM(OD.QUANT * P.Price) AS TotalSpending FROM [dbo].[Customers] AS C
JOIN [dbo].[Orders] AS O ON C.CID = O.CID
JOIN [dbo].[ORDERDETAILS] AS OD ON O.ORID = OD.ORID
JOIN [dbo].[PRODUCTS] AS P ON OD.PID = P.PID
GROUP BY C.CID, C.FName, C.LName)AS A
ORDER BY TotalSpending DESC
--Q9
SELECT A.FNAME,A.LNAME,A.Averageordervalue FROM( 
SELECT C.FName,C.LName, SUM(OD.QUANT*P.Price)/ COUNT(O.ORId) AS AverageOrderValue FROM [dbo].CUSTOMERS AS C
JOIN [dbo].ORDERS AS O ON O.CID = C.CID
JOIN [dbo].ORDERDETAILS AS OD ON O.ORId = OD.ORId
JOIN [dbo].PRODUCTS AS P ON OD.PID = P.PID
GROUP BY C.FName, C.LName) AS A
--Q10
SELECT A.FNAME,A.LNAME,A.Ordercount FROM(
SELECT C.FName, C.LName, COUNT(O.ORID) AS OrderCount FROM [dbo].CUSTOMERS AS C
LEFT JOIN [dbo].ORDERS AS O ON C.CID = O.CID
GROUP BY C.CID, C.FName, C.LName) AS A
ORDER BY OrderCount DESC;
    